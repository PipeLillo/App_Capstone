<ion-content [fullscreen]="true">
  
  <div class="header-content">
    
    <div class="top-buttons">
      
      <ion-back-button 
        defaultHref="/home" 
        class="seg-btn">
      </ion-back-button>

      <ion-button 
        fill="solid" 
        class="filter-button" 
        (click)="onLogout()">
        Cerrar sesión
      </ion-button>
    </div>

    <div class="main-info">
      <h2>Perfil de Usuario</h2>
    </div>
  </div>

  <form
    [formGroup]="form"
    (ngSubmit)="onSubmit()"
    (keydown.enter)="preventFormSubmit($event)"
    novalidate
  >
    <div classs="cards-stack">

      <ion-card class="home-card">
        <ion-card-header>
          <ion-card-title>Datos Básicos</ion-card-title>
        </ion-card-header>
        
        <ion-card-content>
          <ion-list lines="inset">
            <ion-item>
              <ion-label position="stacked">Peso (kg)</ion-label>
              <ion-input
                type="text"
                inputmode="decimal"
                enterkeyhint="done"
                placeholder="Ej: 66.5..."
                formControlName="peso"
                (ionBlur)="formatNumber('peso', 2)">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Altura (cm)</ion-label>
              <ion-input
                type="text"
                inputmode="decimal"
                enterkeyhint="done"
                placeholder="Ej: 170..."
                formControlName="altura"
                (ionBlur)="formatNumber('altura', 2)">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Edad</ion-label>
              <ion-input
                type="number"
                inputmode="numeric"
                min="0"
                max="130"
                placeholder="Ej: 23..."
                formControlName="edad">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Contacto de emergencia</ion-label>
              <ion-input
                type="text"
                placeholder="Nombre y teléfono..."
                formControlName="contactoEmergencia">
              </ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Dirección</ion-label>
              <ion-textarea
                autoGrow="true"
                placeholder="Calle, número, ciudad..."
                formControlName="direccion">
              </ion-textarea>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Contraindicaciones</ion-label>
              <ion-textarea
                autoGrow="true"
                placeholder="Describe contraindicaciones médicas..."
                formControlName="contraindicaciones">
              </ion-textarea>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Medicación permanente</ion-label>
              <ion-textarea
                autoGrow="true"
                placeholder="Medicamentos de uso permanente..."
                formControlName="medicacionPermanente">
              </ion-textarea>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <ion-card class="home-card">
        <ion-card-header>
          <ion-card-title>Enfermedades Crónicas</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="full">
              <div class="input-with-button">
                <ion-input
                  [formControl]="enfermedadCtrl"
                  type="text"
                  placeholder="Ej: diabetes..."
                  (keydown.enter)="onEnfermedadKeydown($event)">
                </ion-input>
                <ion-button fill="outline" (click)="addEnfermedad()">
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Añadir
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
          
          <div class="chips-wrapper ion-padding-start ion-padding-end ion-padding-top">
            <ion-chip *ngFor="let ctrl of enfermedadesFA.controls; let i = index" color="primary">
              <ion-label>{{ ctrl.value }}</ion-label>
              <ion-icon name="close-circle" (click)="removeEnfermedad(i)"></ion-icon>
            </ion-chip>
          </div>
        </ion-card-content>
      </ion-card>
      
      <ion-card class="home-card">
        <ion-card-header>
          <ion-card-title>Alergias</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="full">
              <div class="input-with-button">
                <ion-input
                  [formControl]="alergiaCtrl"
                  type="text"
                  placeholder="Ej: penicilina..."
                  (keydown.enter)="onAlergiaKeydown($event)">
                </ion-input>
                <ion-button fill="outline" (click)="addAlergia()">
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Añadir
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
          
          <div class="chips-wrapper ion-padding-start ion-padding-end ion-padding-top">
            <ion-chip *ngFor="let ctrl of alergiasFA.controls; let i = index" color="tertiary">
              <ion-label>{{ ctrl.value }}</ion-label>
              <ion-icon name="close-circle" (click)="removeAlergia(i)"></ion-icon>
            </ion-chip>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="home-card">
        <ion-card-header>
          <ion-card-title>Discapacidades</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item lines="full">
              <div class="input-with-button">
                <ion-input
                  [formControl]="discapacidadCtrl"
                  type="text"
                  placeholder="Ej: motora leve..."
                  (keydown.enter)="onDiscapacidadKeydown($event)">
                </ion-input>
                <ion-button fill="outline" (click)="addDiscapacidad()">
                  <ion-icon name="add-outline" slot="start"></ion-icon>
                  Añadir
                </ion-button>
              </div>
            </ion-item>
          </ion-list>
          
          <div class="chips-wrapper ion-padding-start ion-padding-end ion-padding-top">
            <ion-chip *ngFor="let ctrl of discapacidadesFA.controls; let i = index" color="success">
              <ion-label>{{ ctrl.value }}</ion-label>
              <ion-icon name="close-circle" (click)="removeDiscapacidad(i)"></ion-icon>
            </ion-chip>
          </div>
        </ion-card-content>
      </ion-card>

    </div> <div class="ion-padding-horizontal ion-padding-bottom">
      <ion-button
        type="submit"
        expand="block"
        [disabled]="loading"
      >
        <ion-spinner *ngIf="loading" slot="start"></ion-spinner>
        <ion-icon *ngIf="!loading" name="save-outline" slot="start"></ion-icon>
        {{ loading ? 'Guardando…' : 'Guardar cambios' }}
      </ion-button>
    </div>

  </form>

</ion-content>